name: HawkScan

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  deployment_status:
  schedule:
    - cron: "0 0 * * 1"

  workflow_dispatch:
    inputs:
      target_url:
        description: "Optional override target URL (e.g. https://your-preview-url)"
        required: false
        type: string

concurrency:
  group: stackhawk-${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  HAWK_API_KEY: ${{ secrets.HAWK_API_KEY }}
  STACKHAWK_APPLICATION_ID: ${{ vars.STACKHAWK_APPLICATION_ID }}
  STACKHAWK_HOST: ${{ github.event.deployment_status.environment_url }}

jobs:
  hawkscan_push_pr:
    name: HawkScan (Push/PR)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    if: >
      (github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'staging')) ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')

    steps:
      - name: Debug deployment info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Checkout (deployment ref)
        uses: actions/checkout@v6

      - name: Skip if StackHawk is not configured
        if: env.HAWK_API_KEY == ''
        run: echo "HAWK_API_KEY is missing; skipping StackHawk." && exit 0

      - name: Determine environment and host
        id: env
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "env_name=Production" >> "$GITHUB_OUTPUT"
            echo "host=https://www.donotghostme.com" >> "$GITHUB_OUTPUT"
          else
            echo "env_name=Staging" >> "$GITHUB_OUTPUT"
            echo "host=https://staging.donotghostme.com" >> "$GITHUB_OUTPUT"
          fi

      - name: Write StackHawk config (stackhawk.yml)
        shell: bash
        run: |
          cat > stackhawk.yml <<'YAML'
          app:
            applicationId: ${{env.STACKHAWK_APPLICATION_ID}}
            env: ${{ steps.env.outputs.env_name }}
            host: ${{ steps.env.outputs.host }}
          tags:
            - name: _STACKHAWK_GIT_COMMIT_SHA
              value: ${COMMIT_SHA}
            - name: _STACKHAWK_GIT_BRANCH
              value: ${BRANCH_NAME}
          hawk:
            failureThreshold: high
            spider:
              base: true
              ajax: true
              maxDurationMinutes: 45
              seedPaths:
                - "/"
                - "/companies"
                - "/api/health"
                - "/api/public/company-intel"
                - "/api/companies/search"
                - "/api/reports"
                - "/api/reports/stats"
                - "/api/admin"
                - "/api/admin/login"
                - "/api/admin/logout"
            config:
              - "spider.processform=false"
              - "spider.postform=false"
          YAML

      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@4c3258cd62248dac6d9fe91dd8d45928c697dee0
        continue-on-error: true
        with:
          apiKey: ${{ env.HAWK_API_KEY }}
          codeScanningAlerts: true
          githubToken: ${{ github.token }}

  debug_deployment_status:
    name: Debug deployment_status payload
    if: github.event_name == 'deployment_status'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "action=${{ github.event.action }}"
          echo "state=${{ github.event.deployment_status.state }}"
          echo "environment=${{ github.event.deployment.environment }}"
          echo "environment_url=${{ github.event.deployment_status.environment_url }}"
          echo "deployment.sha=${{ github.event.deployment.sha }}"
          echo "deployment.ref=${{ github.event.deployment.ref }}"

  hawkscan_main_weekly:
    name: HawkScan (Weekly on main/prod)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    if: >
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      github.ref_name == 'main'

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v6

      - name: Skip if StackHawk is not configured
        if: env.HAWK_API_KEY == ''
        run: echo "HAWK_API_KEY is missing; skipping StackHawk." && exit 0

      - name: Resolve target URL
        id: target
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> "$GITHUB_OUTPUT"
          else
            echo "url=https://www.donotghostme.com" >> "$GITHUB_OUTPUT"
          fi

      - name: Write StackHawk config (stackhawk.yml)
        shell: bash
        run: |
          cat > stackhawk.yml <<'YAML'
          app:
            applicationId: ${{env.STACKHAWK_APPLICATION_ID}}
            env: Production
            host: ${{ steps.target.outputs.url }}
          hawk:
            failureThreshold: high
            spider:
              base: true
              ajax: true
              maxDurationMinutes: 60
              seedPaths:
                - "/"
                - "/companies"
                - "/api/health"
                - "/api/public/company-intel"
                - "/api/companies/search"
                - "/api/reports"
                - "/api/reports/stats"
                - "/api/admin"
                - "/api/admin/login"
                - "/api/admin/logout"
            config:
              - "spider.processform=false"
              - "spider.postform=false"
          YAML

      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@4c3258cd62248dac6d9fe91dd8d45928c697dee0
        continue-on-error: true
        with:
          apiKey: ${{ env.HAWK_API_KEY }}
          codeScanningAlerts: true
          githubToken: ${{ github.token }}
