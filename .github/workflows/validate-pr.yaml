name: Validate pull requests

on:
  pull_request_target:
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review

permissions:
  pull-requests: read

jobs:
  validate:
    name: Validate PR conventions
    runs-on: ubuntu-latest

    steps:
      - name: Validate target branch and linked issue
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            if (!pr) {
              core.setFailed('No pull_request payload found.');
              return;
            }

            // Optional: skip validation for draft PRs
            if (pr.draft) {
              core.info('PR is draft; skipping validation.');
              return;
            }

            // -----------------------------------------------------------------
            // 1) Enforce target branch rules
            // -----------------------------------------------------------------
            const baseBranch = pr.base.ref;
            const prAuthor = pr.user.login;
            const repoOwner = context.repo.owner;

            // Anyone can target staging
            const allowedBranches = ['staging'];

            // Only the repo owner can target main
            if (baseBranch === 'main') {
              if (prAuthor !== repoOwner) {
                core.setFailed(
                  `Invalid base branch "${baseBranch}". Only the repository owner can create pull requests targeting "main". ` +
                  `Contributors should target the "staging" branch instead.`
                );
                return;
              }
              core.info('PR targets main branch - author is repo owner, validation passed.');
            } else if (! allowedBranches.includes(baseBranch)) {
              core.setFailed(
                `Invalid base branch "${baseBranch}". Pull requests must target the "staging" branch. Please change the base to "staging".`
              );
              return;
            }

            // -----------------------------------------------------------------
            // 2) Require a linked issue in title or body
            // -----------------------------------------------------------------
            const title = pr.title || '';
            const body = pr.body || '';
            const text = `${title}\n${body}`;

            // These patterns should mirror .github/config.yaml > issue_link_patterns
            const patterns = [
              /\b(closes|fixes|resolves)\s+#\d+\b/i,
              /\brelated\s+to\s+#\d+\b/i,
            ];

            const hasIssueLink = patterns.some((re) => re.test(text));

            if (!hasIssueLink) {
              core.setFailed(
                'This pull request must be linked to at least one issue. ' +
                'Add a line like "Closes #123", "Fixes #123", "Resolves #123" or "Related to #123" to the description.'
              );
              return;
            }

            core.info('PR validation passed: base branch and issue link look good.');
