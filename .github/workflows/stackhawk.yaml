name: StackHawk DAST

on:
  deployment_status:
  schedule:
    - cron: "0 0 * * 1"

  workflow_dispatch:
    inputs:
      target_url:
        description: "Optional override target URL (e.g. https://your-preview-url)"
        required: false
        type: string

concurrency:
  group: stackhawk-${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  HAWK_API_KEY: ${{ secrets.HAWK_API_KEY }}
  STACKHAWK_APPLICATION_ID: ${{ vars.STACKHAWK_APPLICATION_ID }}
  STACKHAWK_HOST: ${{ github.event.deployment_status.environment_url }}
  SARIF_ARTIFACT: "true"

jobs:
  hawkscan_preview:
    name: HawkScan (Preview deployment)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    if: >
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment == 'Preview' &&
      github.event.deployment_status.environment_url != ''

    steps:
      - name: Checkout (deployment ref)
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.deployment.ref }}
          fetch-depth: 0

      - name: Skip if StackHawk is not configured
        if: env.HAWK_API_KEY == ''
        run: echo "HAWK_API_KEY is missing; skipping StackHawk." && exit 0

      - name: Write StackHawk config (stackhawk.yml)
        shell: bash
        run: |
          cat > stackhawk.yml <<'YAML'
          app:
            applicationId: ${{env.STACKHAWK_APPLICATION_ID}}
            env: Preview
            host: ${{env.STACKHAWK_HOST}}
          hawk:
            outputFile: stackhawk.sarif 
            spider:
              base: true
              ajax: true
              maxDurationMinutes: 45
              seedPaths:
                - "/"
                - "/companies"
                - "/api/health"
                - "/api/public/company-intel"
                - "/api/companies/search"
                - "/api/reports"
                - "/api/reports/stats"
                - "/api/admin"
                - "/api/admin/login"
                - "/api/admin/logout"
            config: 
              - "spider.processform=false"
              - "spider.postform=false"
            scanner:
              maxDurationMinutes: 45
              activeScan:
                # ============================================
                # INJECTION ATTACKS
                # ============================================
                # SQL Injection
                - id: 40018
                  enabled: true
                # SQL Injection - PostgreSQL
                - id: 40022
                  enabled: true
                # Remote OS Command Injection
                - id: 90020
                  enabled: true
                # XPath Injection
                - id: 90021
                  enabled: true
                # CRLF Injection (HTTP Response Splitting)
                - id: 40003
                  enabled: true
                # Server Side Include (SSI) Injection
                - id: 40009
                  enabled: true
                # Parameter Tampering
                - id: 40008
                  enabled: true
                # ============================================
                # CROSS-SITE SCRIPTING (XSS)
                # ============================================
                # Reflected XSS
                - id: 40012
                  enabled: true
                # Persistent XSS (Spider)
                - id: 40014
                  enabled: true
                # Persistent XSS (Prime)
                - id: 40016
                  enabled: true
                # Persistent XSS (Attack)
                - id: 40017
                  enabled: true
                # Out of Band XSS
                - id: 40031
                  enabled: true
                # ============================================
                # FILE INCLUSION & PATH TRAVERSAL
                # ============================================
                # Path Traversal
                - id: 6
                  enabled: true
                # Remote File Inclusion
                - id: 7
                  enabled: true
                # Source Code Disclosure - Git
                - id: 41
                  enabled: true
                # Source Code Disclosure - SVN
                - id: 42
                  enabled: true
                # Source Code Disclosure - File Inclusion
                - id: 43
                  enabled: true
                # Source Code Disclosure - /WEB-INF
                - id: 10045
                  enabled: true
                # Backup File Disclosure
                - id: 10095
                  enabled: true
                # Hidden File Finder
                - id: 40035
                  enabled: true
                # .env Information Leak
                - id: 40034
                  enabled: true
                # .htaccess Information Leak
                - id: 40032
                  enabled: true
                # ============================================
                # AUTHENTICATION & SESSION
                # ============================================
                # Anti-CSRF Tokens Check
                - id: 20012
                  enabled: true
                # Session Fixation
                - id: 40013
                  enabled: true
                # Weak Authentication Method
                - id: 10105
                  enabled: true
                # ============================================
                # KNOWN CVEs & CRITICAL VULNERABILITIES
                # ============================================
                # Log4Shell (CVE-2021-44228)
                - id: 40043
                  enabled: true
                # Spring4Shell (CVE-2022-22965)
                - id: 40044
                  enabled: true
                # Text4Shell (CVE-2022-42889)
                - id: 40045
                  enabled: true
                # Heartbleed OpenSSL Vulnerability
                - id: 20015
                  enabled: true
                # Remote Code Execution - Shell Shock (CVE-2014-6271)
                - id: 10048
                  enabled: true
                # Remote Code Execution - CVE-2012-1823 (PHP CGI)
                - id: 20018
                  enabled: true
                # Source Code Disclosure - CVE-2012-1823 (PHP CGI)
                - id: 20017
                  enabled: true
                # ============================================
                # MISCONFIGURATION & INFORMATION DISCLOSURE
                # ============================================
                # CORS Misconfiguration
                - id: 40040
                  enabled: true
                # Cross-Domain Misconfiguration
                - id: 20016
                  enabled: true
                # External Redirect
                - id: 20019
                  enabled: true
                # Open Redirect
                - id: 10028
                  enabled: true
                # Web Cache Deception
                - id: 40039
                  enabled: true
                # Bypassing 403
                - id: 40038
                  enabled: true
                # HTTP Parameter Pollution
                - id: 20014
                  enabled: true
                # Proxy Disclosure
                - id: 40025
                  enabled: true
                # ELMAH Information Leak
                - id: 40028
                  enabled: true
                # Trace.axd Information Leak
                - id: 40029
                  enabled: true
                # Spring Actuator Information Leak
                - id: 40042
                  enabled: true
                # Directory Browsing
                - id: 0
                  enabled: true
                # ============================================
                # BUFFER OVERFLOW & MEMORY CORRUPTION
                # ============================================
                # Buffer Overflow
                - id: 30001
                  enabled: true
                # Format String Error
                - id: 30002
                  enabled: true
                # Integer Overflow
                - id: 30003
                  enabled: true
                # ============================================
                # HEADER & COOKIE SECURITY
                # ============================================
                # Cookie without Secure flag
                - id: 10010
                  enabled: true
                # Cookie without HttpOnly flag
                - id: 10011
                  enabled: true
                # Cookie without SameSite Attribute
                - id: 10054
                  enabled: true
                # Incomplete or No Cache-control Header
                - id: 10015
                  enabled: true
                # X-Frame-Options Header Not Set
                - id: 10020
                  enabled: true
                # X-Content-Type-Options Header Missing
                - id: 10021
                  enabled: true
                # Strict-Transport-Security Header Not Set
                - id: 10035
                  enabled: true
                # Content Security Policy Header Not Set
                - id: 10038
                  enabled: true
                # Permissions Policy Header Not Set
                - id: 10063
                  enabled: true
                # Content-Type Header Missing
                - id: 10019
                  enabled: true
                # Web Browser XSS Protection Not Enabled
                - id: 10016
                  enabled: true
                # ============================================
                # INFORMATION DISCLOSURE
                # ============================================
                # Information Disclosure - Debug Error Messages
                - id: 10023
                  enabled: true
                # Information Disclosure - Database Error Messages
                - id: 10024
                  enabled: true
                # Information Disclosure - Sensitive Information in URL
                - id: 10025
                  enabled: true
                # Information Disclosure - Suspicious Comments
                - id: 10027
                  enabled: true
                # Server Leaks Version Info via Server HTTP Response Header
                - id: 10036
                  enabled: true
                # Server Leaks Info via X-Powered-By HTTP Response Header
                - id: 10037
                  enabled: true
                # X-Backend-Server Header Information Leak
                - id: 10039
                  enabled: true
                # X-ChromeLogger-Data Header Information Leak
                - id: 10052
                  enabled: true
                # X-Debug-Token Header Information Leak
                - id: 10056
                  enabled: true
                # X-AspNet-Version Response Header
                - id: 10061
                  enabled: true
                # PII Disclosure
                - id: 10062
                  enabled: true
                # Timestamp Disclosure
                - id: 10096
                  enabled: true
                # Hash Disclosure
                - id: 10097
                  enabled: true
                # Source Code Disclosure
                - id: 10099
                  enabled: true
                # ============================================
                # JAVASCRIPT & CLIENT-SIDE
                # ============================================
                # Vulnerable JS Library
                - id: 10003
                  enabled: true
                # Cross-Domain JavaScript Source File Inclusion
                - id: 10017
                  enabled: true
                # Dangerous JS Functions
                - id: 10110
                  enabled: true
                # ============================================
                # MISCELLANEOUS
                # ============================================
                # HTTP Parameter Override
                - id: 10026
                  enabled: true
                # Cookie Poisoning
                - id: 10029
                  enabled: true
                # User Controllable Charset
                - id: 10030
                  enabled: true
                # User Controllable HTML Element Attribute
                - id: 10031
                  enabled: true
                # Viewstate
                - id: 10032
                  enabled: true
                # Heartbleed OpenSSL Vulnerability (Passive)
                - id: 10034
                  enabled: true
                # Secure Pages Include Mixed Content
                - id: 10040
                  enabled: true
                # HTTP to HTTPS Insecure Transition
                - id: 10041
                  enabled: true
                # User Controllable Cookie
                - id: 10043
                  enabled: true
                # Big Redirect Detected
                - id: 10044
                  enabled: true
                # Retrieved from Cache
                - id: 10050
                  enabled: true
                # Username Hash Found
                - id: 10057
                  enabled: true
                # GET for POST
                - id: 10058
                  enabled: true
                # User Agent Fuzzer
                - id: 10104
                  enabled: true
                # HTTP Only Site
                - id: 10106
                  enabled: true
                # HTTPS Content Available via HTTP
                - id: 10107
                  enabled: true
                # Reverse Tabnabbing
                - id: 10108
                  enabled: true
                # Modern Web Application
                - id: 10109
                  enabled: true
                # Authentication Request Identified
                - id: 10111
                  enabled: true
                # Cross-Domain Misconfiguration (Passive)
                - id: 10098
                  enabled: true
          YAML

      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@4c3258cd62248dac6d9fe91dd8d45928c697dee0
        with:
          apiKey: ${{ env.HAWK_API_KEY }}
          codeScanningAlerts: false
          githubToken: ${{ github.token }}

      - name: Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: stackhawk.sarif
          ref: ${{ github.event_name == 'deployment_status' && (startsWith(github.event.deployment.ref, 'refs/') && github.event.deployment.ref || format('refs/heads/{0}', github.event.deployment.ref)) || github.ref }}
          sha: ${{ github.event_name == 'deployment_status' && github.event.deployment.sha || github.sha }}

  debug_deployment_status:
    name: Debug deployment_status payload
    if: github.event_name == 'deployment_status'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "action=${{ github.event.action }}"
          echo "state=${{ github.event.deployment_status.state }}"
          echo "environment=${{ github.event.deployment.environment }}"
          echo "environment_url=${{ github.event.deployment_status.environment_url }}"

  hawkscan_main_weekly:
    name: HawkScan (Weekly on main/prod)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    if: >
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      github.ref_name == 'main'

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Skip if StackHawk is not configured
        if: env.HAWK_API_KEY == ''
        run: echo "HAWK_API_KEY is missing; skipping StackHawk." && exit 0

      - name: Resolve target URL
        id: target
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> "$GITHUB_OUTPUT"
          else
            echo "url=https://www.donotghostme.com" >> "$GITHUB_OUTPUT"
          fi

      - name: Write StackHawk config (stackhawk.yml)
        shell: bash
        run: |
          cat > stackhawk.yml <<'YAML'
          app:
            applicationId: ${{env.STACKHAWK_APPLICATION_ID}}
            env: Production
            host: ${{ steps.target.outputs.url }}
          hawk:
            outputFile: stackhawk.sarif 
            spider:
              base: true
              ajax: true
              maxDurationMinutes: 90
              seedPaths:
                - "/"
                - "/companies"
                - "/api/health"
                - "/api/public/company-intel"
                - "/api/companies/search"
                - "/api/reports"
                - "/api/reports/stats"
                - "/api/admin"
                - "/api/admin/login"
                - "/api/admin/logout"
            config: 
              - "spider.processform=false"
              - "spider.postform=false"
             scanner:
              maxDurationMinutes: 90
              activeScan:
                # ============================================
                # INJECTION ATTACKS
                # ============================================
                # SQL Injection
                - id: 40018
                  enabled: true
                # SQL Injection - PostgreSQL
                - id: 40022
                  enabled: true
                # Remote OS Command Injection
                - id: 90020
                  enabled: true
                # XPath Injection
                - id: 90021
                  enabled: true
                # CRLF Injection (HTTP Response Splitting)
                - id: 40003
                  enabled: true
                # Server Side Include (SSI) Injection
                - id: 40009
                  enabled: true
                # Parameter Tampering
                - id: 40008
                  enabled: true
                # ============================================
                # CROSS-SITE SCRIPTING (XSS)
                # ============================================
                # Reflected XSS
                - id: 40012
                  enabled: true
                # Persistent XSS (Spider)
                - id: 40014
                  enabled: true
                # Persistent XSS (Prime)
                - id: 40016
                  enabled: true
                # Persistent XSS (Attack)
                - id: 40017
                  enabled: true
                # Out of Band XSS
                - id: 40031
                  enabled: true
                # ============================================
                # FILE INCLUSION & PATH TRAVERSAL
                # ============================================
                # Path Traversal
                - id: 6
                  enabled: true
                # Remote File Inclusion
                - id: 7
                  enabled: true
                # Source Code Disclosure - Git
                - id: 41
                  enabled: true
                # Source Code Disclosure - SVN
                - id: 42
                  enabled: true
                # Source Code Disclosure - File Inclusion
                - id: 43
                  enabled: true
                # Source Code Disclosure - /WEB-INF
                - id: 10045
                  enabled: true
                # Backup File Disclosure
                - id: 10095
                  enabled: true
                # Hidden File Finder
                - id: 40035
                  enabled: true
                # .env Information Leak
                - id: 40034
                  enabled: true
                # .htaccess Information Leak
                - id: 40032
                  enabled: true
                # ============================================
                # AUTHENTICATION & SESSION
                # ============================================
                # Anti-CSRF Tokens Check
                - id: 20012
                  enabled: true
                # Session Fixation
                - id: 40013
                  enabled: true
                # Weak Authentication Method
                - id: 10105
                  enabled: true
                # ============================================
                # KNOWN CVEs & CRITICAL VULNERABILITIES
                # ============================================
                # Log4Shell (CVE-2021-44228)
                - id: 40043
                  enabled: true
                # Spring4Shell (CVE-2022-22965)
                - id: 40044
                  enabled: true
                # Text4Shell (CVE-2022-42889)
                - id: 40045
                  enabled: true
                # Heartbleed OpenSSL Vulnerability
                - id: 20015
                  enabled: true
                # Remote Code Execution - Shell Shock (CVE-2014-6271)
                - id: 10048
                  enabled: true
                # Remote Code Execution - CVE-2012-1823 (PHP CGI)
                - id: 20018
                  enabled: true
                # Source Code Disclosure - CVE-2012-1823 (PHP CGI)
                - id: 20017
                  enabled: true
                # ============================================
                # MISCONFIGURATION & INFORMATION DISCLOSURE
                # ============================================
                # CORS Misconfiguration
                - id: 40040
                  enabled: true
                # Cross-Domain Misconfiguration
                - id: 20016
                  enabled: true
                # External Redirect
                - id: 20019
                  enabled: true
                # Open Redirect
                - id: 10028
                  enabled: true
                # Web Cache Deception
                - id: 40039
                  enabled: true
                # Bypassing 403
                - id: 40038
                  enabled: true
                # HTTP Parameter Pollution
                - id: 20014
                  enabled: true
                # Proxy Disclosure
                - id: 40025
                  enabled: true
                # ELMAH Information Leak
                - id: 40028
                  enabled: true
                # Trace.axd Information Leak
                - id: 40029
                  enabled: true
                # Spring Actuator Information Leak
                - id: 40042
                  enabled: true
                # Directory Browsing
                - id: 0
                  enabled: true
                # ============================================
                # BUFFER OVERFLOW & MEMORY CORRUPTION
                # ============================================
                # Buffer Overflow
                - id: 30001
                  enabled: true
                # Format String Error
                - id: 30002
                  enabled: true
                # Integer Overflow
                - id: 30003
                  enabled: true
                # ============================================
                # HEADER & COOKIE SECURITY
                # ============================================
                # Cookie without Secure flag
                - id: 10010
                  enabled: true
                # Cookie without HttpOnly flag
                - id: 10011
                  enabled: true
                # Cookie without SameSite Attribute
                - id: 10054
                  enabled: true
                # Incomplete or No Cache-control Header
                - id: 10015
                  enabled: true
                # X-Frame-Options Header Not Set
                - id: 10020
                  enabled: true
                # X-Content-Type-Options Header Missing
                - id: 10021
                  enabled: true
                # Strict-Transport-Security Header Not Set
                - id: 10035
                  enabled: true
                # Content Security Policy Header Not Set
                - id: 10038
                  enabled: true
                # Permissions Policy Header Not Set
                - id: 10063
                  enabled: true
                # Content-Type Header Missing
                - id: 10019
                  enabled: true
                # Web Browser XSS Protection Not Enabled
                - id: 10016
                  enabled: true
                # ============================================
                # INFORMATION DISCLOSURE
                # ============================================
                # Information Disclosure - Debug Error Messages
                - id: 10023
                  enabled: true
                # Information Disclosure - Database Error Messages
                - id: 10024
                  enabled: true
                # Information Disclosure - Sensitive Information in URL
                - id: 10025
                  enabled: true
                # Information Disclosure - Suspicious Comments
                - id: 10027
                  enabled: true
                # Server Leaks Version Info via Server HTTP Response Header
                - id: 10036
                  enabled: true
                # Server Leaks Info via X-Powered-By HTTP Response Header
                - id: 10037
                  enabled: true
                # X-Backend-Server Header Information Leak
                - id: 10039
                  enabled: true
                # X-ChromeLogger-Data Header Information Leak
                - id: 10052
                  enabled: true
                # X-Debug-Token Header Information Leak
                - id: 10056
                  enabled: true
                # X-AspNet-Version Response Header
                - id: 10061
                  enabled: true
                # PII Disclosure
                - id: 10062
                  enabled: true
                # Timestamp Disclosure
                - id: 10096
                  enabled: true
                # Hash Disclosure
                - id: 10097
                  enabled: true
                # Source Code Disclosure
                - id: 10099
                  enabled: true
                # ============================================
                # JAVASCRIPT & CLIENT-SIDE
                # ============================================
                # Vulnerable JS Library
                - id: 10003
                  enabled: true
                # Cross-Domain JavaScript Source File Inclusion
                - id: 10017
                  enabled: true
                # Dangerous JS Functions
                - id: 10110
                  enabled: true
                # ============================================
                # MISCELLANEOUS
                # ============================================
                # HTTP Parameter Override
                - id: 10026
                  enabled: true
                # Cookie Poisoning
                - id: 10029
                  enabled: true
                # User Controllable Charset
                - id: 10030
                  enabled: true
                # User Controllable HTML Element Attribute
                - id: 10031
                  enabled: true
                # Viewstate
                - id: 10032
                  enabled: true
                # Heartbleed OpenSSL Vulnerability (Passive)
                - id: 10034
                  enabled: true
                # Secure Pages Include Mixed Content
                - id: 10040
                  enabled: true
                # HTTP to HTTPS Insecure Transition
                - id: 10041
                  enabled: true
                # User Controllable Cookie
                - id: 10043
                  enabled: true
                # Big Redirect Detected
                - id: 10044
                  enabled: true
                # Retrieved from Cache
                - id: 10050
                  enabled: true
                # Username Hash Found
                - id: 10057
                  enabled: true
                # GET for POST
                - id: 10058
                  enabled: true
                # User Agent Fuzzer
                - id: 10104
                  enabled: true
                # HTTP Only Site
                - id: 10106
                  enabled: true
                # HTTPS Content Available via HTTP
                - id: 10107
                  enabled: true
                # Reverse Tabnabbing
                - id: 10108
                  enabled: true
                # Modern Web Application
                - id: 10109
                  enabled: true
                # Authentication Request Identified
                - id: 10111
                  enabled: true
                # Cross-Domain Misconfiguration (Passive)
                - id: 10098
                  enabled: true
          YAML

      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@4c3258cd62248dac6d9fe91dd8d45928c697dee0
        with:
          apiKey: ${{ env.HAWK_API_KEY }}
          codeScanningAlerts: false
          githubToken: ${{ github.token }}

      - name: Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: stackhawk.sarif
          ref: ${{ github.ref }}
          sha: ${{ github.sha }}
