name: StackHawk DAST

on:
  deployment_status:
  schedule:
    - cron: "0 0 * * 1"

  workflow_dispatch:
    inputs:
      target_url:
        description: "Optional override target URL (e.g. https://your-preview-url)"
        required: false
        type: string

concurrency:
  group: stackhawk-${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  HAWK_API_KEY: ${{ secrets.HAWK_API_KEY }}
  STACKHAWK_APPLICATION_ID: ${{ vars.STACKHAWK_APPLICATION_ID }}
  STACKHAWK_HOST: ${{ github.event.deployment_status.environment_url }}

jobs:
  hawkscan_preview:
    name: HawkScan (Preview deployment)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    if: >
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment == 'Preview' &&
      github.event.deployment_status.environment_url != ''
    

    steps:
      - name: Checkout (deployment ref)
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.deployment.ref }}
          fetch-dept: 0

      - name: Skip if StackHawk is not configured
        if: env.HAWK_API_KEY == ''
        run: echo "HAWK_API_KEY is missing; skipping StackHawk." && exit 0

      - name: Write StackHawk config (stackhawk.yml)
        shell: bash
        run: |
          cat > stackhawk.yml <<'YAML'
          app:
            applicationId: ${{env.STACKHAWK_APPLICATION_ID}}
            env: Preview
            host: ${{env.STACKHAWK_HOST}}
          hawk: 
            spider:
              base: true
              ajax: true
              maxDurationMinutes: 15
              seedPaths:
                - "/"
                - "/companies"
                - "/api/health"
                - "/api/company-intel"
                - "/api/reports"
                - "/api/admin"
            config: 
              spider.processform: false
              spider.postform: false
          YAML
         
      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@4c3258cd62248dac6d9fe91dd8d45928c697dee0
        with:
          apiKey: ${{ env.HAWK_API_KEY }}
          codeScanningAlerts: true
          githubToken: ${{ github.token }}

  debug_deployment_status:
    name: Debug deployment_status payload
    if: github.event_name == 'deployment_status'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "action=${{ github.event.action }}"
          echo "state=${{ github.event.deployment_status.state }}"
          echo "environment=${{ github.event.deployment.environment }}"
          echo "environment_url=${{ github.event.deployment_status.environment_url }}"

  hawkscan_main_weekly:
    name: HawkScan (Weekly on main/prod)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    if: >
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      github.ref_name == 'main'

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Skip if StackHawk is not configured
        if: env.HAWK_API_KEY == ''
        run: echo "HAWK_API_KEY is missing; skipping StackHawk." && exit 0

      - name: Resolve target URL
        id: target
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> "$GITHUB_OUTPUT"
          else
            echo "url=https://www.donotghostme.com" >> "$GITHUB_OUTPUT"
          fi

      - name: Write StackHawk config (stackhawk.yml)
        shell: bash
        run: |
          cat > stackhawk.yml <<'YAML'
          app:
            applicationId: ${{env.STACKHAWK_APPLICATION_ID}}
            env: Preview
            host: ${{env.STACKHAWK_HOST}}
          hawk: 
            spider:
              base: true
              ajax: true
              maxDurationMinutes: 15
              seedPaths:
                - "/"
                - "/companies"
                - "/api/health"
                - "/api/company-intel"
                - "/api/reports"
                - "/api/admin"
            config: 
              spider.processform: false
              spider.postform: false
          YAML

      - name: Run HawkScan
        uses: stackhawk/hawkscan-action@4c3258cd62248dac6d9fe91dd8d45928c697dee0
        with:
          apiKey: ${{ env.HAWK_API_KEY }}
          codeScanningAlerts: true
          githubToken: ${{ github.token }}
