// Prisma schema for the "do-not-ghost-me" application.
// The database stores anonymous ghosting reports, company metadata,
// rate limiting state, and a minimal admin user for moderation.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // URL is provided via prisma.config.ts / env("DATABASE_URL").
  // Keeping it out of the schema avoids accidental check-in of connection strings.
}

/// Hiring process stage at which the candidate stopped receiving responses.
enum Stage {
  CV_SCREEN
  FIRST_INTERVIEW
  TECHNICAL
  HR_INTERVIEW
  OFFER
  OTHER
}

/// Seniority level of the position for which the candidate applied.
enum JobLevel {
  INTERN
  JUNIOR
  MID
  SENIOR
  LEAD
  OTHER
}

/// Coarse-grained functional category of the position.
enum PositionCategory {
  IT
  ENGINEERING
  FINANCE_ACCOUNTING
  AUDIT_ADVISORY
  CONSULTING
  HR
  SALES_MARKETING
  RESEARCH_DEVELOPMENT
  DESIGN
  PRODUCT
  OPERATIONS
  PROJECT_PROGRAM
  ADMINISTRATION
  LEGAL_COMPLIANCE
  CUSTOMER_SUPPORT
  EDUCATION_TRAINING
  HEALTHCARE_LIFE_SCIENCES
  SUPPLY_CHAIN_LOGISTICS
  OTHER
}

/// ISO 3166-1 alpha-2 country code for the candidate's location.
/// This is stored per report instead of on the company.
enum CountryCode {
  AD
  AE
  AF
  AG
  AI
  AL
  AM
  AO
  AQ
  AR
  AS
  AT
  AU
  AW
  AX
  AZ
  BA
  BB
  BD
  BE
  BF
  BG
  BH
  BI
  BJ
  BL
  BM
  BN
  BO
  BQ
  BR
  BS
  BT
  BV
  BW
  BY
  BZ
  CA
  CC
  CD
  CF
  CG
  CH
  CI
  CK
  CL
  CM
  CN
  CO
  CR
  CU
  CV
  CW
  CX
  CY
  CZ
  DE
  DJ
  DK
  DM
  DO
  DZ
  EC
  EE
  EG
  EH
  ER
  ES
  ET
  FI
  FJ
  FK
  FM
  FO
  FR
  GA
  GB
  GD
  GE
  GF
  GG
  GH
  GI
  GL
  GM
  GN
  GP
  GQ
  GR
  GS
  GT
  GU
  GW
  GY
  HK
  HM
  HN
  HR
  HT
  HU
  ID
  IE
  IL
  IM
  IN
  IO
  IQ
  IR
  IS
  IT
  JE
  JM
  JO
  JP
  KE
  KG
  KH
  KI
  KM
  KN
  KP
  KR
  KW
  KY
  KZ
  LA
  LB
  LC
  LI
  LK
  LR
  LS
  LT
  LU
  LV
  LY
  MA
  MC
  MD
  ME
  MF
  MG
  MH
  MK
  ML
  MM
  MN
  MO
  MP
  MQ
  MR
  MS
  MT
  MU
  MV
  MW
  MX
  MY
  MZ
  NA
  NC
  NE
  NF
  NG
  NI
  NL
  NO
  NP
  NR
  NU
  NZ
  OM
  PA
  PE
  PF
  PG
  PH
  PK
  PL
  PM
  PN
  PR
  PS
  PT
  PW
  PY
  QA
  RE
  RO
  RS
  RU
  RW
  SA
  SB
  SC
  SD
  SE
  SG
  SH
  SI
  SJ
  SK
  SL
  SM
  SN
  SO
  SR
  SS
  ST
  SV
  SX
  SY
  SZ
  TC
  TD
  TF
  TG
  TH
  TJ
  TK
  TL
  TM
  TN
  TO
  TR
  TT
  TV
  TW
  TZ
  UA
  UG
  UM
  US
  UY
  UZ
  VA
  VC
  VE
  VG
  VI
  VN
  VU
  WF
  WS
  YE
  YT
  ZA
  ZM
  ZW
}

/// Moderation status of a report.
enum ReportStatus {
  ACTIVE
  FLAGGED
  DELETED
}

/// Company that appears in one or more ghosting reports.
/// A company is deduplicated by a normalized name.
model Company {
  id             String      @id @default(cuid())
  name           String
  normalizedName String
  country        CountryCode
  createdAt      DateTime    @default(now())

  reports Report[]

  @@unique([normalizedName, country], name: "uniq_company_name_country")
  @@index([createdAt], name: "idx_company_created_at")
}

/// Anonymous ghosting report submitted by a candidate.
/// This model is intentionally minimal and stores no personal identifiers.
model Report {
  id               String           @id @default(cuid())
  company          Company          @relation(fields: [companyId], references: [id])
  companyId        String
  stage            Stage
  jobLevel         JobLevel
  positionCategory PositionCategory

  /// Short free-text position label provided by the user (for example "Backend Engineer").
  positionDetail String @db.VarChar(80)

  /// Number of days the candidate has waited without receiving a reply.
  daysWithoutReply Int? @db.SmallInt

  createdAt DateTime @default(now())

  // Moderation fields

  status        ReportStatus @default(ACTIVE)
  flaggedAt     DateTime?
  flaggedReason String?      @db.VarChar(255)
  deletedAt     DateTime?

  moderatedByAdmin   AdminUser? @relation("AdminModeratedReports", fields: [moderatedByAdminId], references: [id])
  moderatedByAdminId String?

  @@index([status, companyId], name: "idx_report_status_company")
  @@index([createdAt], name: "idx_report_created_at")
  @@index([companyId], name: "idx_report_company_id")
  @@index([status, flaggedAt], name: "idx_report_status_flagged_at")
}

/// Per-IP, per-company, per-position rate-limiting key.
/// Used to prevent repeated submissions for the same company/position combination.
model ReportIpCompanyLimit {
  id String @id @default(cuid())

  /// Hex-encoded HMAC of the remote IP address.
  ipHash String @db.VarChar(128)

  companyId String

  /// Normalized combination of category and position detail.
  positionKey String @db.VarChar(160)

  createdAt DateTime @default(now())

  @@unique([ipHash, companyId, positionKey], name: "uniq_ip_company_position")
  @@index([ipHash, companyId], name: "idx_ip_company")
}

/// Per-IP daily rate-limiting counter.
/// Used to cap the total number of reports from a single IP per UTC day.
model ReportIpDailyLimit {
  id String @id @default(cuid())

  /// Hex-encoded HMAC of the remote IP address.
  ipHash String @db.VarChar(128)

  /// UTC day key in the format YYYY-MM-DD (for example "2025-12-07").
  day String @db.VarChar(10)

  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ipHash, day], name: "uniq_ip_day")
  @@index([day], name: "idx_day")
}

/// Persistent state for admin login rate limiting per IP.
model AdminLoginRateLimit {
  id String @id @default(cuid())

  /// Hex-encoded HMAC of the remote IP address.
  ipHash String @unique @db.VarChar(128)

  attempts       Int
  firstAttemptAt DateTime
  lockedUntil    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Minimal admin user model for future multi-user admin accounts.
/// Currently the app relies on a single env-based password, but this model
/// allows attaching moderation actions to a specific admin in the future.
model AdminUser {
  id    String @id @default(cuid())
  email String @unique

  /// Hashed password for the admin user.
  password String @db.VarChar(255)

  createdAt DateTime @default(now())

  moderatedReports Report[] @relation("AdminModeratedReports")
}
